<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ConsumelogMapper">
	
	
	<!-- 新增-->
	<insert id="save" parameterType="pd">
		insert into TB_CONSUMELOG(
			USERID,	
			USER_ID,	
			WEBCHAT_ID,	
			CREATE_TIME,	
			MONEY,	
			CONSUMES,
			ARTICLE_CHAPTER_ID,
			ARTICLE_ID,
			ARTICLE_NAME,
			CHAPTER_NAME
		) values (
			#{USERID},	
			#{USER_ID},	
			#{WEBCHAT_ID},	
			#{CREATE_TIME},	
			#{MONEY},	
			#{CONSUMES},
			#{ARTICLE_CHAPTER_ID},
			#{ARTICLE_ID},
			#{ARTICLE_NAME},
			#{CHAPTER_NAME}
		)
	</insert>
	
	
	<!-- 删除-->
	<delete id="delete" parameterType="pd">
		delete from TB_CONSUMELOG
		where 
			CONSUMELOG_ID = #{CONSUMELOG_ID}
	</delete>
	
	
	<!-- 修改 -->
	<update id="edit" parameterType="pd">
		update  TB_CONSUMELOG
			set 
				USERID = #{USERID},
				USER_ID = #{USER_ID},
				WEBCHAT_ID = #{WEBCHAT_ID},
				CREATE_TIME = #{CREATE_TIME},
				MONEY = #{MONEY},
				CONSUMES = #{CONSUMES},
				ARTICLE_CHAPTER_ID = #{ARTICLE_CHAPTER_ID},
				ARTICLE_ID = #{ARTICLE_ID},
				ARTICLE_NAME = #{ARTICLE_NAME},
				CHAPTER_NAME = #{CHAPTER_NAME}
			where 
				CONSUMELOG_ID = #{CONSUMELOG_ID}
	</update>
	
	
	<!-- 通过ID获取数据 -->
	<select id="findById" parameterType="pd" resultType="pd">
		select 
			CONSUMELOG_ID,	
			USERID,	
			USER_ID,	
			WEBCHAT_ID,	
			CREATE_TIME,	
			MONEY,	
			CONSUMES,
			ARTICLE_CHAPTER_ID,
			ARTICLE_ID,
			ARTICLE_NAME,
			CHAPTER_NAME
		from 
			TB_CONSUMELOG
		where 
			CONSUMELOG_ID = #{CONSUMELOG_ID}
	</select>
	
	
	<!-- 列表 -->
	<select id="datalistPage" parameterType="page" resultType="pd">
		select 
				tu.NICKNAME,
				su.NAME,
				a.USERID,
				a.USER_ID,
				a.CREATE_TIME,
				tu.FOLLOWSTATE,
				tu.CUMULATIVE_CURRENCY,
				tu.BOOK_CURRENCY,
				tu.CUMULATIVE_CURRENCY - tu.BOOK_CURRENCY BOOKCURRENCYS,
				tsl.QBOOK_CURRENCY,
				a.ARTICLE_ID,
				a.ARTICLE_NAME,
				a.ARTICLE_CHAPTER_ID,
				a.CHAPTER_NAME
		from 
				tb_consumelog a
				LEFT JOIN sys_user su ON a.USER_ID = su.USER_ID
				LEFT JOIN tb_user tu ON a.USERID = tu.USERID
				LEFT JOIN (
					SELECT 
						SUM(BOOK_CURRENCY) QBOOK_CURRENCY,
						USERID
					from tb_sign_log
						GROUP BY USERID
				)tsl ON a.USERID = tsl.USERID
		where 1=1
				<if test="pd.names!=null and pd.names!=''">
					AND (
							tu.NICKNAME LIKE CONCAT(CONCAT('%', #{pd.names}),'%')
							or
							su.NAME LIKE CONCAT(CONCAT('%', #{pd.names}),'%')
							or
							a.USERID LIKE CONCAT(CONCAT('%', #{pd.names}),'%')
						)
				</if>
				<if test="pd.sendTimeBegin!=null and pd.sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{pd.sendTimeBegin}
				</if>
				<if test="pd.sendTimeEnd!=null and pd.sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{pd.sendTimeEnd}
				 ]]>   
				</if>
				<if test="pd.FOLLOWSTATE!=null and pd.FOLLOWSTATE!=''">
					AND tu.FOLLOWSTATE = #{pd.FOLLOWSTATE}
				</if>
	</select>
	
	<!-- 列表(全部)excel -->
	<select id="listAll" parameterType="pd" resultType="pd">
		select 
				tu.NICKNAME,
				su.NAME,
				a.USER_ID,
				a.USERID,
				a.CREATE_TIME,
				tu.FOLLOWSTATE,
				tu.CUMULATIVE_CURRENCY,
				tu.BOOK_CURRENCY,
				tu.CUMULATIVE_CURRENCY - tu.BOOK_CURRENCY BOOKCURRENCYS,
				IFNULL(tsl.QBOOK_CURRENCY,0) QBOOK_CURRENCY,
				a.ARTICLE_ID,
				a.ARTICLE_NAME,
				a.ARTICLE_CHAPTER_ID,
				a.CHAPTER_NAME
		from 
				tb_consumelog a
				LEFT JOIN sys_user su ON a.USER_ID = su.USER_ID
				LEFT JOIN tb_user tu ON a.USERID = tu.USERID
				LEFT JOIN (
					SELECT 
						ifnull(SUM(BOOK_CURRENCY),0) QBOOK_CURRENCY,
						USERID
					from tb_sign_log
						GROUP BY USERID
				)tsl ON a.USERID = tsl.USERID
		where 1=1
				<if test="names!=null and names!=''">
					AND (
							tu.NICKNAME LIKE CONCAT(CONCAT('%', #{names}),'%')
							or
							su.NAME LIKE CONCAT(CONCAT('%', #{names}),'%')
							or
							a.USERID LIKE CONCAT(CONCAT('%', #{names}),'%')
						)
				</if>
				<if test="sendTimeBegin!=null and sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{sendTimeBegin}
				</if>
				<if test="sendTimeEnd!=null and sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{sendTimeEnd}
				 ]]>   
				</if>
				<if test="FOLLOWSTATE!=null and FOLLOWSTATE!=''">
					AND tu.FOLLOWSTATE = #{FOLLOWSTATE}
				</if>
	</select>
	
	<!-- 批量删除 -->
	<delete id="deleteAll" parameterType="String">
		delete from TB_CONSUMELOG
		where 
			CONSUMELOG_ID in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
                 #{item}
		</foreach>
	</delete>
	
	
	<!-- 通过userid获取数据 -->
	<select id="countConsumelogDay" parameterType="pd" resultType="pd">
		select 
			count(CONSUMELOG_ID) CONSUMENUMBERS,<!-- 消费笔数 -->
			sum(MONEY) CONSUMEMONEY  <!-- 消费金额 -->
		from 
			TB_CONSUMELOG
		where 
			USER_ID = #{USER_ID}
			<if test="CREATE_TIME != null and CREATE_TIME != '' ">
				and CREATE_TIME LIKE CONCAT(CONCAT('', #{CREATE_TIME}),'%')
			</if>
	</select>
	
	<!-- 获取消费数据 -->
	<select id="pdConsumelog" parameterType="pd" resultType="pd">
		select 
			count(CONSUMELOG_ID) CONSUMENUMBERS,<!-- 消费笔数 -->
			IFNULL(sum(CONSUMES),0) CONSUMEMONEY  <!-- 消费金额 -->
		from 
			TB_CONSUMELOG
		where 1 = 1
			<if test="TIME!=null and TIME!=''">
				AND CREATE_TIME LIKE CONCAT(CONCAT('', #{TIME}),'%')
			</if>
	</select>
	
	
	<!-- 渠道消费列表-->
	<select id="sysuserConsumelistPage" parameterType="page" resultType="pd">
		select 
				tu.NICKNAME,
				a.USERID,
				a.USER_ID,
				a.CREATE_TIME,
				a.ARTICLE_ID,
				a.ARTICLE_NAME,
				a.ARTICLE_CHAPTER_ID,
				a.CHAPTER_NAME,
				a.CONSUMES
		from 
				tb_consumelog a
				LEFT JOIN tb_user tu ON a.USERID = tu.USERID
		where a.USER_ID = #{pd.USER_ID}
				<if test="pd.names!=null and pd.names!=''">
					AND (
							tu.NICKNAME LIKE CONCAT(CONCAT('%', #{pd.names}),'%')
							or
							a.USER_ID LIKE CONCAT(CONCAT('%', #{pd.names}),'%')
						)
				</if>
				<if test="pd.sendTimeBegin!=null and pd.sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{pd.sendTimeBegin}
				</if>
				<if test="pd.sendTimeEnd!=null and pd.sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{pd.sendTimeEnd}
				 ]]>   
				</if>
	</select>
	
	<!--  导出渠道消费信息excel-->
	<select id="listsysuserConsumeExce" parameterType="pd" resultType="pd">
		select 
				tu.NICKNAME,
				a.USERID,
				a.USER_ID,
				a.CREATE_TIME,
				a.ARTICLE_ID,
				a.ARTICLE_NAME,
				a.ARTICLE_CHAPTER_ID,
				a.CHAPTER_NAME,
				a.CONSUMES
		from 
				tb_consumelog a
				LEFT JOIN tb_user tu ON a.USERID = tu.USERID
		where a.USER_ID = #{USER_ID}
				<if test="names!=null and names!=''">
					AND (
							tu.NICKNAME LIKE CONCAT(CONCAT('%', #{names}),'%')
							or
							a.USER_ID LIKE CONCAT(CONCAT('%', #{names}),'%')
						)
				</if>
				<if test="sendTimeBegin!=null and sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{sendTimeBegin}
				</if>
				<if test="sendTimeEnd!=null and sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{sendTimeEnd}
				 ]]>   
				</if>
	</select>
	
	<!-- 渠道消费信息  累计/当月/当天/昨天 -->
	<select id="sysUserConsume" parameterType="pd" resultType="pd">
		select 
				ifnull(SUM(CONSUMES),0) CONSUMES ,
				COUNT(CONSUMELOG_ID) CONSUMELOG_ID
		from 
				tb_consumelog
		where USER_ID = #{USER_ID}
				<if test="TIME!=null and TIME!=''">
					and CREATE_TIME like CONCAT(CONCAT('', #{TIME}),'%')
				</if>
	</select>
	
	<!-- 渠道读者消费列表-->
	<select id="sysUserReadConsumelistPage" parameterType="page" resultType="pd">
		select 
				a.USERID,
				a.USER_ID,
				a.CREATE_TIME,
				a.ARTICLE_ID,
				a.ARTICLE_NAME,
				a.ARTICLE_CHAPTER_ID,
				a.CHAPTER_NAME,
				a.CONSUMES
		from 
				tb_consumelog a
		where a.USERID = #{pd.USERID}
				<if test="pd.names!=null and pd.names!=''">
					AND (
							a.ARTICLE_NAME LIKE CONCAT(CONCAT('%', #{pd.names}),'%')
							or
							a.CHAPTER_NAME LIKE CONCAT(CONCAT('%', #{pd.names}),'%')
						)
				</if>
				<if test="pd.sendTimeBegin!=null and pd.sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{pd.sendTimeBegin}
				</if>
				<if test="pd.sendTimeEnd!=null and pd.sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{pd.sendTimeEnd}
				 ]]>   
				</if>
	</select>
	
	<!-- 渠道读者消费信息  累计/当月/当天/昨天 -->
	<select id="sysUserpdConsumelog" parameterType="pd" resultType="pd">
		select 
				SUM(CONSUMES) CONSUMES ,
				COUNT(CONSUMELOG_ID) CONSUMELOG_ID
		from 
				tb_consumelog
		where USERID = #{USERID}
				<if test="TIME!=null and TIME!=''">
					and CREATE_TIME like CONCAT(CONCAT('', #{TIME}),'%')
				</if>
	</select>
	<!-- 导出渠道读者消费记录信息到Excel-->
	<select id="listsysUserReadConsumeExce" parameterType="pd" resultType="pd">
		select 
				a.USERID,
				a.USER_ID,
				a.CREATE_TIME,
				a.ARTICLE_ID,
				a.ARTICLE_NAME,
				a.ARTICLE_CHAPTER_ID,
				a.CHAPTER_NAME,
				a.CONSUMES
		from 
				tb_consumelog a
		where a.USERID = #{USERID}
				<if test="names!=null and names!=''">
					AND (
							a.ARTICLE_NAME LIKE CONCAT(CONCAT('%', #{names}),'%')
							or
							a.CHAPTER_NAME LIKE CONCAT(CONCAT('%', #{names}),'%')
						)
				</if>
				<if test="sendTimeBegin!=null and sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{sendTimeBegin}
				</if>
				<if test="sendTimeEnd!=null and sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{sendTimeEnd}
				 ]]>   
				</if>
	</select>
	
	
	<!-- 读者管理：读者 累计/月/当天/前一天 消费记录） -->
	<select id="readerChapter" parameterType="pd" resultType="pd">
			select
				count(CONSUMELOG_ID) readerChapterTimes,
				sum(CONSUMES) FEES
			from
				tb_consumelog
			where 
				USERID in(
					select USERID from tb_user where OPENID = #{OPENID}
				)
				and
				CREATE_TIME like CONCAT(CONCAT('', #{TIME}),'%')
	</select>
	
	<!--  读者管理：读者消费记录 -->
	<select id="listUser" parameterType="page" resultType="pd">
		select
				a.USERID,
				a.USER_ID,
				a.CREATE_TIME,
				a.ARTICLE_ID,
				a.ARTICLE_NAME,
				a.ARTICLE_CHAPTER_ID,
				a.CHAPTER_NAME,
				a.CONSUMES FEE,
				su.USER_ID,
				su.NAME
		from 
				tb_consumelog a
				LEFT JOIN sys_user su ON a.USER_ID = su.USER_ID
		where
				a.USERID in(
					select USERID from tb_user where OPENID = #{pd.OPENID}
				) 
				<if test="pd.sendTimeBegin!=null and pd.sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{pd.sendTimeBegin}
				</if>
				<if test="pd.sendTimeEnd!=null and pd.sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{pd.sendTimeEnd}
				 ]]>   
				</if>
				<if test="pd.ARTICLE_NAME!=null and pd.ARTICLE_NAME!=''">
					and a.ARTICLE_NAME like CONCAT(CONCAT('%', #{pd.ARTICLE_NAME}),'%')
				</if>
				ORDER BY a.ARTICLE_NAME DESC
	</select>
	
	<!--  读者管理：读者消费记录导出excel -->
	<select id="listUserexcel" parameterType="pd" resultType="pd">
		select
				a.USERID,
				a.USER_ID,
				a.CREATE_TIME,
				a.ARTICLE_ID,
				a.ARTICLE_NAME,
				a.ARTICLE_CHAPTER_ID,
				a.CHAPTER_NAME,
				a.CONSUMES FEE,
				su.USER_ID,
				su.NAME
		from 
				tb_consumelog a
				LEFT JOIN sys_user su ON a.USER_ID = su.USER_ID
		where
				a.USERID in(
					select USERID from tb_user where OPENID = #{pd.OPENID}
				) 
				<if test="sendTimeBegin!=null and sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{sendTimeBegin}
				</if>
				<if test="sendTimeEnd!=null and sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{sendTimeEnd}
				 ]]>   
				</if>
				<if test="ARTICLE_NAME!=null and ARTICLE_NAME!=''">
					and a.ARTICLE_NAME like CONCAT(CONCAT('%', #{ARTICLE_NAME}),'%')
				</if>
	</select>
	
	
	<!-- 渠道端 -->
	<!-- 渠道读者消费列表-->
	<select id="channelReadConsumelistPage" parameterType="page" resultType="pd">
		select 
				a.USERID,
				a.USER_ID,
				a.CREATE_TIME,
				a.ARTICLE_ID,
				a.ARTICLE_NAME,
				a.ARTICLE_CHAPTER_ID,
				a.CHAPTER_NAME,
				a.CONSUMES
		from 
				tb_consumelog a
		where a.USERID = #{pd.USERID}
				<if test="pd.names!=null and pd.names!=''">
					AND (
							a.ARTICLE_NAME LIKE CONCAT(CONCAT('%', #{pd.names}),'%')
							or
							a.CHAPTER_NAME LIKE CONCAT(CONCAT('%', #{pd.names}),'%')
						)
				</if>
				<if test="pd.sendTimeBegin!=null and pd.sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{pd.sendTimeBegin}
				</if>
				<if test="pd.sendTimeEnd!=null and pd.sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{pd.sendTimeEnd}
				 ]]>   
				</if>
				ORDER BY a.CREATE_TIME DESC
	</select>
	
	<!-- 渠道读者消费信息  累计/当月/当天/昨天 -->
	<select id="channelpdConsumelog" parameterType="pd" resultType="pd">
		select 
				IFNULL(SUM(CONSUMES),0) CONSUMES ,
				COUNT(CONSUMELOG_ID) CONSUMELOG_ID
		from 
				tb_consumelog
		where USERID = #{USERID}
				<if test="TIME!=null and TIME!=''">
					and CREATE_TIME like CONCAT(CONCAT('', #{TIME}),'%')
				</if>
	</select>
	<!-- 导出渠道读者消费记录信息到Excel-->
	<select id="channelReadConsumeExce" parameterType="pd" resultType="pd">
		select 
				a.USERID,
				a.USER_ID,
				a.CREATE_TIME,
				a.ARTICLE_ID,
				a.ARTICLE_NAME,
				a.ARTICLE_CHAPTER_ID,
				a.CHAPTER_NAME,
				a.CONSUMES
		from 
				tb_consumelog a
		where a.USERID = #{USERID}
				<if test="names!=null and names!=''">
					AND (
							a.ARTICLE_NAME LIKE CONCAT(CONCAT('%', #{names}),'%')
							or
							a.CHAPTER_NAME LIKE CONCAT(CONCAT('%', #{names}),'%')
						)
				</if>
				<if test="sendTimeBegin!=null and sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{sendTimeBegin}
				</if>
				<if test="sendTimeEnd!=null and sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{sendTimeEnd}
				 ]]>   
				</if>
	</select>
		
	
</mapper>