<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SingLogMapper">
	
	
	<!-- 新增-->
	<insert id="save" parameterType="pd">
		insert into TB_SIGN_LOG(
			USERID,	
			USER_ID,	
			WEBCHAT_ID,	
			LOG_TYPE,	
			TIMES,	
			BOOK_CURRENCY,	
			CREATE_TIME,	
			SIGN_MONTH
		) values (
			#{USERID},	
			#{USER_ID},	
			#{WEBCHAT_ID},	
			#{LOG_TYPE},	
			#{TIMES},	
			#{BOOK_CURRENCY},	
			#{CREATE_TIME},	
			#{SIGN_MONTH}
		)
	</insert>
	
	
	<!-- 删除-->
	<delete id="delete" parameterType="pd">
		delete from TB_SIGN_LOG
		where 
			SIGN_LOG_ID = #{SIGN_LOG_ID}
	</delete>
	
	
	<!-- 修改 -->
	<update id="edit" parameterType="pd">
		update  TB_SIGN_LOG
			set 
				USERID = #{USERID},
				USER_ID = #{USER_ID},
				WEBCHAT_ID = #{WEBCHAT_ID},
				LOG_TYPE = #{LOG_TYPE},
				TIMES = #{TIMES},
				BOOK_CURRENCY = #{BOOK_CURRENCY},
				CREATE_TIME = #{CREATE_TIME},
				SIGN_MONTH = #{SIGN_MONTH}
			where 
				SIGN_LOG_ID = #{SIGN_LOG_ID}
	</update>
	
	
	<!-- 通过ID获取数据 -->
	<select id="findById" parameterType="pd" resultType="pd">
		select 
			SIGN_LOG_ID,	
			USERID,	
			USER_ID,	
			WEBCHAT_ID,	
			LOG_TYPE,	
			TIMES,	
			BOOK_CURRENCY,	
			CREATE_TIME,	
			SIGN_MONTH
		from 
			TB_SIGN_LOG
		where 
			SIGN_LOG_ID = #{SIGN_LOG_ID}
	</select>
	
	
	<!-- 列表 -->
	<select id="datalistPage" parameterType="page" resultType="pd">
		select
				a.SIGN_LOG_ID,	
				a.USERID,	
				a.USER_ID,	
				a.WEBCHAT_ID,	
				a.LOG_TYPE,	
				a.TIMES,	
				a.BOOK_CURRENCY,	
				a.CREATE_TIME,	
				a.SIGN_MONTH
		from 
				TB_SIGN_LOG a
	</select>
	
	<!-- 列表(全部) -->
	<select id="listAll" parameterType="pd" resultType="pd">
		select
				a.SIGN_LOG_ID,	
				a.USERID,	
				a.USER_ID,	
				a.WEBCHAT_ID,	
				a.LOG_TYPE,	
				a.TIMES,	
				a.BOOK_CURRENCY,	
				a.CREATE_TIME,	
				a.SIGN_MONTH
		from 
				TB_SIGN_LOG a
	</select>
	
	<!-- 批量删除 -->
	<delete id="deleteAll" parameterType="String">
		delete from TB_SIGN_LOG
		where 
			SIGN_LOG_ID in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
                 #{item}
		</foreach>
	</delete>
	
	<!-- 统计累计阅读币 -->
	<select id="countSingLogUserCurrency"  parameterType="pd" resultType="pd">
		select 

			SUM(BOOK_CURRENCY) CURRENCY
		from 
			TB_SIGN_LOG
	</select>
	
	<!-- 统计每天累计签到阅读币和签到人数 -->
	<select id="countSingLogUserCurrencDay"  parameterType="pd" resultType="pd">
		select 
			COUNT(SIGN_LOG_ID) SINGUSERSDAY,
			SUM(BOOK_CURRENCY) CURRENCYDAY
		from 
			TB_SIGN_LOG
		where
			CREATE_TIME like CONCAT(CONCAT('', #{CREATE_TIME}),'%')
	</select>
	
	<!-- 统计每月累计签到阅读币数 -->
	<select id="countSingLogUserCurrencyMonth"  parameterType="pd" resultType="pd">
		select 
			SUM(BOOK_CURRENCY) CURRENCYMONTH
		from 
			TB_SIGN_LOG
		where
			SIGN_MONTH = #{SIGN_MONTH}
	</select>
	
	<!-- 统计每月累计签到阅读币数 -->
	<select id="countSingLogUserMonth"  parameterType="pd" resultType="pd">
		select 
			COUNT(USERID) SINGUSERSMONTH
		from 
			TB_SIGN_LOG
		where
			SIGN_MONTH = #{SIGN_MONTH}
		group by USERID
	</select>
	
	
	<!-- 通过uuid统计个人每月累计签到阅读币数 -->
	<select id="readsSingsMonth"  parameterType="pd" resultType="pd">
		select 
			COUNT(USERID) SINGSMONTHUSER,
			SUM(BOOK_CURRENCY) BOOK_CURRENCYS
		from 
			TB_SIGN_LOG
		where
			CREATE_TIME like CONCAT(CONCAT('', #{CREATE_TIME}),'%')
			<if test="USERID != null and USERID != '' ">
				USERID = ${USERID}
			</if>
	</select>
	
	<!-- 总签到统计 -->
	<select id="seachSing"  parameterType="pd" resultType="pd">
		select 
			COUNT(RECHARGE_ID) RECHARGE_IDS,
			SUM(BOOK_CURRENCY) BOOK_CURRENCYSS
		from 
			TB_SIGN_LOG
	</select>
	
	<!-- 今天签到统计 -->
	<select id="seachSingLogDay"  parameterType="pd" resultType="pd">
		select 
			COUNT(RECHARGE_ID) DRECHARGE_ID,
			SUM(BOOK_CURRENCY) DBOOK_CURRENCYS
		from 
			TB_SIGN_LOG
		where
			CREATE_TIME like CONCAT(CONCAT('', #{CREATE_TIME}),'%')
	</select>
	
	<!-- 本月签到统计 -->
	<select id="seachSingLogMonth"  parameterType="pd" resultType="pd">
		select 
			COUNT(RECHARGE_ID) MRECHARGE_ID,
			SUM(BOOK_CURRENCY) MBOOK_CURRENCYS
		from 
			TB_SIGN_LOG
		where
			CREATE_TIME like CONCAT(CONCAT('', #{CREATE_TIME}),'%')
	</select>
	
	<!-- 昨天签到统计 -->
	<select id="seachSingLogYserterDay"  parameterType="pd" resultType="pd">
		select 
			COUNT(RECHARGE_ID) YDRECHARGE_ID,
			SUM(BOOK_CURRENCY) YDBOOK_CURRENCYS
		from 
			TB_SIGN_LOG
		where
			CREATE_TIME like CONCAT(CONCAT('', #{CREATE_TIME}),'%')
	</select>
	
	<!-- 读者管理：读者 累计/月/当天/前一天 签到记录） -->
	<select id="readerSing" parameterType="pd" resultType="pd">
			select
				count(SIGN_LOG_ID) readerSingTimes,
				sum(BOOK_CURRENCY) BOOK_CURRENCYS
			from
				TB_SIGN_LOG
			where 
				USERID in(
					select USERID from tb_user where USER_CODE = #{USER_CODE}
				) 
				and
				CREATE_TIME like CONCAT(CONCAT('', #{TIME}),'%')
	</select>
	
	<!-- 读者管理：读者签到记录 -->
	<select id="listUserlistPage"  parameterType="page" resultType="pd">
		select 
				a.SIGN_LOG_ID,	
				a.USER_ID,	
				a.BOOK_CURRENCY,	
				a.CREATE_TIME,	
				su.USERID,
				su.NAME,
				tsl.SBC<!-- 渠道累计签到 -->
		from
				TB_SIGN_LOG a 
				LEFT JOIN sys_user su ON a.USER_ID = su.USER_ID 
				LEFT JOIN (
					select
						count(BOOK_CURRENCY) SBC,
						USER_ID
					from 
						TB_SIGN_LOG
					where
						USERID in(
								select USERID from tb_user where USER_CODE = #{pd.USER_CODE}
						) GROUP BY USER_ID
				)tsl ON a.USER_ID = tsl.USER_ID
		 where
		 		a.USERID in(
					select USERID from tb_user where USER_CODE = #{pd.USER_CODE}
				)
				<if test="pd.sendTimeBegin!=null and pd.sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{pd.sendTimeBegin}
				</if>
				<if test="pd.sendTimeEnd!=null and pd.sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{pd.sendTimeEnd}
				 ]]>   
				</if>
				<if test="pd.NAME!=null and pd.NAME!=''">
					AND su.NAME LIKE CONCAT(CONCAT('%', #{pd.NAME}),'%')
				</if>
	</select>
	<!-- 读者管理：导出读者签到记录excel -->
	<select id="listReadexcel"  parameterType="page" resultType="pd">
		select 
				a.SIGN_LOG_ID,	
				a.USER_ID,	
				a.BOOK_CURRENCY,	
				a.CREATE_TIME,	
				su.USERID,
				su.NAME,
				tsl.SBC<!-- 渠道累计签到 -->
		from
				TB_SIGN_LOG a 
				LEFT JOIN sys_user su ON a.USER_ID = su.USER_ID 
				LEFT JOIN (
					select
						count(BOOK_CURRENCY) SBC,
						USER_ID
					from 
						TB_SIGN_LOG
					where
						USERID in(
								select USERID from tb_user where USER_CODE = #{USER_CODE}
						) GROUP BY USER_ID
				)tsl ON a.USER_ID = tsl.USER_ID
		 where
		 		a.USERID in(
					select USERID from tb_user where USER_CODE = #{USER_CODE}
				)
				<if test="sendTimeBegin!=null and sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{sendTimeBegin}
				</if>
				<if test="sendTimeEnd!=null and sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{sendTimeEnd}
				 ]]>   
				</if>
				<if test="NAME!=null and NAME!=''">
					AND su.NAME LIKE CONCAT(CONCAT('%', #{NAME}),'%')
				</if>
	</select>
	
	
	<!--读者管理：获取当天签到的渠道和是否签到 -->
	<select id="readerSingDay" parameterType="pd" resultType="pd">
		select 
			a.SIGN_LOG_ID,	
			a.USERID,	
			a.USER_ID,	
			a.WEBCHAT_ID,	
			a.LOG_TYPE,	
			a.TIMES,	
			a.BOOK_CURRENCY,	
			a.CREATE_TIME,	
			a.SIGN_MONTH,
			su.NAME
		from 
			TB_SIGN_LOG a
			LEFT JOIN sys_user su ON a.USER_ID = su.USER_ID
		where 
			a.USERID in(
				select USERID from tb_user where USER_CODE = #{USER_CODE}
			)
			and
			a.CREATE_TIME like CONCAT(CONCAT('', #{TIME}),'%')
			limit 0,1
	</select>
	
	<!-- 读者管理：读者签到记录 -->
	<select id="listsysuserSinglistPage"  parameterType="page" resultType="pd">
		select 
				a.SIGN_LOG_ID,	
				a.USER_ID,	
				a.BOOK_CURRENCY,	
				a.CREATE_TIME,
				su.USERID,
				tu.NICKNAME,
				tsl.SBC<!-- 渠道累计签到阅读币 -->
		from
				TB_SIGN_LOG a 
				LEFT JOIN sys_user su ON a.USER_ID = su.USER_ID 
				LEFT JOIN tb_user tu ON a.USER_ID = tu.USER_ID
				LEFT JOIN (
					select
						sum(BOOK_CURRENCY) SBC,
						USERID
					from 
						TB_SIGN_LOG
					where USER_ID = #{pd.USER_ID}
					GROUP BY USERID
				)tsl ON a.USERID = tsl.USERID
		 where a.USER_ID = #{pd.USER_ID}
				<if test="pd.sendTimeBegin!=null and pd.sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{pd.sendTimeBegin}
				</if>
				<if test="pd.sendTimeEnd!=null and pd.sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{pd.sendTimeEnd}
				 ]]>   
				</if>
				<if test="pd.names!=null and pd.names!=''">
					AND (
						tu.NICKNAME like CONCAT(CONCAT('%', #{pd.names}),'%')
						or
						a.USER_ID like CONCAT(CONCAT('%', #{pd.names}),'%')
					)
				</if>
	</select>
	
	<!-- 获取渠道 累计/月/当天/ 签到记录 -->
	<select id="sysUserSing" parameterType="pd" resultType="pd">
		select 
			count(SIGN_LOG_ID) sysUserSingTimes,
			ifnull(sum(BOOK_CURRENCYS),0) BOOK_CURRENCYS 
		FROM(
			select
				SIGN_LOG_ID,
				sum(BOOK_CURRENCY) BOOK_CURRENCYS
			from
				TB_SIGN_LOG
				where  USER_ID = #{USER_ID}
					<if test="TIME!=null and TIME!=''">
						and CREATE_TIME like CONCAT(CONCAT('', #{TIME}),'%')
					</if>
					GROUP BY USERID
		)sysUserSing  	
	</select>
	
	<!-- 获取渠道累计签到人数-->
	<select id="sysUserSingTotalP" parameterType="pd" resultType="pd">
		select 
			COUNT(USERID) USERIDS
		from(	
			select 
				USERID
			FROM
				tb_sign_log
			WHERE
				USER_ID = #{USER_ID}
				GROUP BY USERID
		)tsl
	</select>
	<!-- 获取渠道累计签到次数-->
	<select id="sysUserSingTotalC" parameterType="pd" resultType="pd">
		select 
			COUNT(USERID) COUNTS
		FROM
			tb_sign_log
		WHERE
			USER_ID = #{USER_ID}
	</select>
	
	<!-- 导出excel渠道签到 -->
	<select id="listsysuserSingexcel"  parameterType="pd" resultType="pd">
		select 
				a.SIGN_LOG_ID,	
				a.USER_ID,	
				a.BOOK_CURRENCY,	
				a.CREATE_TIME,
				su.USERID,
				tu.NICKNAME,
				tsl.SBC<!-- 渠道累计签到阅读币 -->
		from
				TB_SIGN_LOG a 
				LEFT JOIN sys_user su ON a.USER_ID = su.USER_ID 
				LEFT JOIN tb_user tu ON a.USER_ID = tu.USER_ID
				LEFT JOIN (
					select
						sum(BOOK_CURRENCY) SBC,
						USERID
					from 
						TB_SIGN_LOG
					where USER_ID = #{USER_ID}
					GROUP BY USERID
				)tsl ON a.USERID = tsl.USERID
		 where a.USER_ID = #{USER_ID}
				<if test="sendTimeBegin!=null and sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{sendTimeBegin}
				</if>
				<if test="sendTimeEnd!=null and sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{sendTimeEnd}
				 ]]>   
				</if>
				<if test="names!=null and names!=''">
					AND (
						tu.NICKNAME like CONCAT(CONCAT('%', #{names}),'%')
						or
						a.USER_ID like CONCAT(CONCAT('%', #{names}),'%')
					)
				</if>
	</select>

	<!--  渠道读者签到列表 -->
	<select id="sysUserReadSignlistPage"  parameterType="page" resultType="pd">
		SELECT
				a.SIGN_LOG_ID,
				a.USER_ID,
				a.USERID,
				a.BOOK_CURRENCY,
				a.CREATE_TIME,
				tsl.SBC
		FROM
				TB_SIGN_LOG a
				LEFT JOIN (
				SELECT
					sum(BOOK_CURRENCY) SBC,
					USERID
				FROM
					TB_SIGN_LOG
				WHERE
					USERID = #{pd.USERID}
				) tsl ON a.USERID = tsl.USERID
		WHERE a.USERID = #{pd.USERID}
				<if test="pd.sendTimeBegin!=null and pd.sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{pd.sendTimeBegin}
				</if>
				<if test="pd.sendTimeEnd!=null and pd.sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{pd.sendTimeEnd}
				 ]]>   
				</if>
	</select>
	<!-- 渠道读者 累计/月/当天/前一天 签到记录-->
	<select id="sysUserReadSing" parameterType="pd" resultType="pd">
		SELECT
				count(SIGN_LOG_ID) SIGN_LOG_ID,
				sum(BOOK_CURRENCY) BOOK_CURRENCYS
		FROM
				TB_SIGN_LOG
		WHERE
				USERID = #{USERID}
				<if test="TIME!=null and TIME!=''">
					AND CREATE_TIME like CONCAT(CONCAT('', #{TIME}),'%')
				</if>
	</select>
	<!-- 渠道读者：获取当前渠道是否签到-->
	<select id="sysUserReadSingDay" parameterType="pd" resultType="pd">
		SELECT
				a.SIGN_LOG_ID,
				su.NAME
		FROM
				TB_SIGN_LOG a
				LEFT JOIN sys_user su ON a.USER_ID = su.USER_ID
		WHERE
				a.USERID = #{USERID}
				<if test="TIME!=null and TIME!=''">
					AND a.CREATE_TIME LIKE CONCAT(CONCAT('', #{TIME}),'%')
				</if>
				AND a.USER_ID = (
					SELECT
						USER_ID
					FROM
						TB_SIGN_LOG
					WHERE
						USERID = #{USERID}
						LIMIT 0,1
				) 
	</select>
	<!--  导出excel渠道读者签到列表 -->
	<select id="listsysUserReadSingexcel"  parameterType="pd" resultType="pd">
		SELECT
				a.SIGN_LOG_ID,
				a.USER_ID,
				a.USERID,
				a.BOOK_CURRENCY,
				a.CREATE_TIME,
				tsl.SBC
		FROM
				TB_SIGN_LOG a
				LEFT JOIN (
				SELECT
					sum(BOOK_CURRENCY) SBC,
					USERID
				FROM
					TB_SIGN_LOG
				WHERE
					USERID = #{USERID}
				) tsl ON a.USERID = tsl.USERID
		WHERE a.USERID = #{USERID}
				<if test="sendTimeBegin!=null and sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{sendTimeBegin}
				</if>
				<if test="sendTimeEnd!=null and sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{sendTimeEnd}
				 ]]>   
				</if>
	</select>
	
	<!-- 渠道端 -->
	
	
	<!--  渠道读者签到列表 -->
	<select id="channelReadSignlistPage"  parameterType="page" resultType="pd">
		SELECT
				a.SIGN_LOG_ID,
				a.USER_ID,
				a.USERID,
				a.BOOK_CURRENCY,
				a.CREATE_TIME,
				tsl.SBC
		FROM
				TB_SIGN_LOG a
				LEFT JOIN (
				SELECT
					IFNULL(sum(BOOK_CURRENCY),0) SBC,
					USERID
				FROM
					TB_SIGN_LOG
				WHERE
					USERID = #{pd.USERID}
				) tsl ON a.USERID = tsl.USERID
		WHERE a.USERID = #{pd.USERID}
				<if test="pd.sendTimeBegin!=null and pd.sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{pd.sendTimeBegin}
				</if>
				<if test="pd.sendTimeEnd!=null and pd.sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{pd.sendTimeEnd}
				 ]]>   
				</if>
	</select>
	<!-- 渠道读者 累计/月/当天/前一天 签到记录-->
	<select id="channelReadSing" parameterType="pd" resultType="pd">
		SELECT
				COUNT(SIGN_LOG_ID) SIGN_LOG_ID,
				IFNULL(sum(BOOK_CURRENCY),0) BOOK_CURRENCYS
		FROM
				TB_SIGN_LOG
		WHERE
				USERID = #{USERID}
				<if test="TIME!=null and TIME!=''">
					AND CREATE_TIME like CONCAT(CONCAT('', #{TIME}),'%')
				</if>
	</select>
	<!-- 渠道读者：获取当前渠道是否签到-->
	<select id="channelReadSingDay" parameterType="pd" resultType="pd">
		SELECT
				IFNULL(SIGN_LOG_ID,0) SIGN_LOG_ID
		FROM
				TB_SIGN_LOG
		WHERE
				USERID = #{USERID}
				<if test="TIME!=null and TIME!=''">
					AND CREATE_TIME like CONCAT(CONCAT('', #{TIME}),'%')
				</if>
	</select>
	<!--  导出excel渠道读者签到列表 -->
	<select id="channelUserReadSingexcel"  parameterType="pd" resultType="pd">
		SELECT
				a.SIGN_LOG_ID,
				a.USER_ID,
				a.USERID,
				a.BOOK_CURRENCY,
				a.CREATE_TIME,
				tsl.SBC
		FROM
				TB_SIGN_LOG a
				LEFT JOIN (
				SELECT
					sum(BOOK_CURRENCY) SBC,
					USERID
				FROM
					TB_SIGN_LOG
				WHERE
					USERID = #{USERID}
				) tsl ON a.USERID = tsl.USERID
		WHERE a.USERID = #{USERID}
				<if test="sendTimeBegin!=null and sendTimeBegin!='' ">
					AND a.CREATE_TIME>=#{sendTimeBegin}
				</if>
				<if test="sendTimeEnd!=null and sendTimeEnd!='' ">
				  <![CDATA[   
					AND a.CREATE_TIME <= #{sendTimeEnd}
				 ]]>   
				</if>
	</select>
	
</mapper>