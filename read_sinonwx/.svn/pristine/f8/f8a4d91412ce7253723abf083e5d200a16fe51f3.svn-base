<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>
<%@ page import="com.sinontech.modle.*" %>
<%
	String path = request.getContextPath();
	String basePath = request.getScheme() + "://"
			+ request.getServerName() + ":" + request.getServerPort()
			+ path + "/";
	 
	String tradeno = (String)request.getAttribute("tradeno");
	Rechargeset set = (Rechargeset)request.getAttribute("set");
	String timeStamp = String.valueOf(request.getAttribute("timeStamp"));
	String nonceStr = String.valueOf(request.getAttribute("nonceStr"));
	String prepayId = String.valueOf(request.getAttribute("prepayId"));
	String paySign = String.valueOf(request.getAttribute("paySign"));
	String appid = String.valueOf(request.getAttribute("appid"));
	String md5 = String.valueOf(request.getAttribute("md5"));
	String tradeNo = String.valueOf(request.getAttribute("tradeNo"));
	System.out.println(tradeNo+"====timeStamp="+timeStamp+"=nonceStr="+nonceStr+"=prepayId="+prepayId);
 
%>

<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<base href="<%=basePath%>">
	<meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
    <title>支付方式</title>
    <link rel="stylesheet" type="text/css" href="pages/home/read/css/base.css">
    <link rel="stylesheet" type="text/css" href="pages/home/read/css/index.css">
    <script src='pages/home/read/js/jquery-1.12.4.min.js'></script>
</head>
<body>
	<div class="paymentMethodTop clearfix">
		<img src="pages/home/read/images/myPic20.png" alt="" />
		<div>
			<h1><span>￥</span><%=set.getMoney()*0.01 %>元</h1>
			<h2><%=set.getBookCurrency() %>阅读币
			<%if(set.getBookCurrencyGift()>0){ %>
				+<%=set.getBookCurrencyGift() %>阅读币
				<%} %>
			</h2>
		</div>
	</div>
	<div class="paymentMethodDet clearfix">
		<span>微信支付</span>
		<img src="pages/home/read/images/myPic23.png" alt="" />
	</div>
	<div class="paymentMethodBtn" onclick="pay()">确认支付&nbsp;&nbsp;￥<%=set.getMoney()*0.01 %>元</div>
	<script>
		$('.paymentMethodDet img').click(function(){
			if($(this).attr('src')=='pages/home/read/images/myPic23.png'){
				$(this).attr('src','pages/home/read/images/myPic22.png');
				$('.paymentMethodBtn').css('background','#cccccc');
			}else{
				$(this).attr('src','pages/home/read/images/myPic23.png');
				$('.paymentMethodBtn').css('background','#55adef');
			}
		})
		function pay(){
			//alert("调用微信支付，开发中");
			if (typeof WeixinJSBridge == "undefined"){
				alert(3);
			   if( document.addEventListener ){
			       document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
			   }else if (document.attachEvent){
			       document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
			       document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
			   }
			}else{
			   onBridgeReady();
			}
		}
	</script>
	<script>
 
	function onBridgeReady(){
	   WeixinJSBridge.invoke(
	       'getBrandWCPayRequest', {
	           "appId":"<%=appid%>",     //公众号名称，由商户传入     
	           "timeStamp":"<%=timeStamp%>",         //时间戳，自1970年以来的秒数     
	           "nonceStr":"<%=nonceStr%>", //随机串     
	           "package":"<%=prepayId%>",     
	           "signType":"MD5",         //微信签名方式：     
	           "paySign":"<%=paySign%>" //微信签名 
	       },
	       function(res){   
	    	  // alert(res);  
	           if(res.err_msg == "get_brand_wcpay_request:ok" ) {
					window.location.href="<%=basePath%>recharge/order/<%=tradeNo%>";
		       }     // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。 
	       }
	   ); 
	}
 

 
</script>
	<script src="pages/home/read/js/rem.js"></script>
</body>
</html>



