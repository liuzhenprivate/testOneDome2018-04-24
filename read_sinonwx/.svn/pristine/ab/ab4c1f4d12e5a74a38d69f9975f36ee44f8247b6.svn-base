package com.sinontech.controller;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.InputStreamReader;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;

import com.sinontech.modle.ArticleChapter;
import com.sinontech.modle.ArticleChapterLog;
import com.sinontech.modle.ArticleLog;
import com.sinontech.modle.ConsumeLog;
import com.sinontech.modle.UserInfo;
import com.sinontech.pub.utils.DateUtil;
import com.sinontech.service.impl.ArticleChapterLogServiceImpl;
import com.sinontech.service.impl.ArticleChapterServiceImpl;
import com.sinontech.service.impl.ArticleLogServiceImpl;
import com.sinontech.service.impl.ConsumeLogServiceImpl;
import com.sinontech.service.impl.UserInfoServiceImpl;
import com.sinontech.service.impl.WebchatServiceImpl;

import common.Logger;

@Controller("articlechaptercontroller")
@RequestMapping(value = "/articlechapter")
public class ArticleChapterController {
	protected static final Logger logger = Logger
			.getLogger(ArticleController.class);

	@Autowired
	WebchatServiceImpl webchatServiceImpl;
	@Autowired
	UserInfoServiceImpl userinfoService;
	@Autowired
	ArticleChapterServiceImpl articleChapterServiceImpl;
	@Autowired
	ArticleChapterLogServiceImpl articleChapterLogServiceImpl;
	@Autowired
	ConsumeLogServiceImpl consumeLogServiceImpl;
	@Autowired
	ArticleLogServiceImpl articleLogServiceImpl;
	
	/**
	 * @purpose：查询书籍章节内容
	 * @param userId
	 * @param articlechapterid
	 * @param request
	 * @param response
	 * @return String
	 * @author liuzhen
	 * @Time：2018-3-11 上午11:09:28
	 */
	@RequestMapping(value = "/articlechapterGetById/{articlechapterid}/{userId}")
	public String articlechapterGetById(@PathVariable long userId,@PathVariable long articlechapterid,
			HttpServletRequest request,HttpServletResponse response) {
		ArticleChapter articleChapter = null;
		String chapterTxt = "";
		try {
			articleChapter = articleChapterServiceImpl.getArticleChapterById(articlechapterid);
			if (articleChapter.getIsFree() == 1) {
				UserInfo user = userinfoService.getUserInfoById(userId);
				if (user != null) {
					if (articleChapter.getConsumes() < (user.getCumulativeCurrency()-user.getBookCurrency())) {
						// String pathUrl =
						// "G:/apache-tomcat-7.0.85/webapps/read_sinon/";
						// 获取当前项目路径
						String projectpath = request.getSession().getServletContext().getRealPath("/");
						// 读取文件
						File filename = new File(projectpath+ articleChapter.getContentUrl());
						InputStreamReader reader = new InputStreamReader(new FileInputStream(filename), "utf-8");
						BufferedReader br = new BufferedReader(reader);
						String line = "";
						line = br.readLine();
						while (line != null) {
							line = br.readLine();
							chapterTxt = chapterTxt + line + "\r\n";
						}
						request.setAttribute("articleChapter", articleChapter);
						request.setAttribute("chapterTxt", chapterTxt);
						user.setBookCurrency((user.getBookCurrency()+articleChapter.getConsumes()));
						userinfoService.updateUserInfo(user);
						
						String dateTime = DateUtil.getStringNow();
						
						ArticleChapterLog articleChapterLog = new ArticleChapterLog();
						articleChapterLog.setArticle(articleChapter.getArticle());
						articleChapterLog.setArticleChapter(articleChapter);
						articleChapterLog.setFee(articleChapter.getConsumes());
						articleChapterLog.setCreateTime(dateTime);
						articleChapterLog.setArticleName(articleChapter.getArticle().getArticleName());
						articleChapterLog.setChannelId(user.getChannelId());
						articleChapterLog.setChapterName(articleChapter.getChapterName());
						articleChapterLog.setUserId(user.getId());
						articleChapterLog.setWebchatId(user.getWebchatId());
						articleChapterLogServiceImpl.saveArticleChapterLog(articleChapterLog);
						
						ConsumeLog consumeLog = new ConsumeLog();
						consumeLog.setUserId(userId);
						consumeLog.setChannelId(user.getChannelId());
						consumeLog.setWebchatId(user.getWebchatId());
						consumeLog.setArticleId(articleChapter.getArticle().getId());
						consumeLog.setArticleChapterId(articleChapter.getId());
						consumeLog.setArticleName(articleChapter.getArticle().getArticleName());
						consumeLog.setChapterName(articleChapter.getChapterName());
						consumeLog.setCreateTime(dateTime);
						consumeLog.setConsumes(articleChapter.getConsumes());
						consumeLog.setConsumeType(0);
						consumeLogServiceImpl.saveConsumeLog(consumeLog);
						
						ArticleLog articleLog = new ArticleLog();
						articleLog.setArticle(articleChapter.getArticle());
						articleLog.setUserId(userId);
						articleLog.setChannelId(user.getChannelId());
						articleLog.setWebchatId(user.getWebchatId());
						articleLog.setArticleChapter(articleChapter);
						articleLog.setArticleName(articleChapter.getArticle().getArticleName());
						articleLog.setChapterName(articleChapter.getChapterName());
						articleLog.setCreateTime(dateTime);
						articleLog.setFee(articleChapter.getConsumes());
						articleLogServiceImpl.saveArticleLog(articleLog);
						System.out.println("收费章节，阅读币足够");
					}else{
						//如果用户账户里剩余阅读币不够购买下一下章节
						request.setAttribute("articleChapter", articleChapter);
						request.setAttribute("chapterTxt", chapterTxt);
						request.setAttribute("currency", 0);
						System.out.println("收费章节，阅读币不够");
					}
				}else{
					//如果用户为空
					return null;
				}
			}else{
				//如果章节免费
				// String pathUrl =
				// "G:/apache-tomcat-7.0.85/webapps/read_sinon/";
				// 获取当前项目路径
				String projectpath = request.getSession().getServletContext().getRealPath("/");
				// 读取文件
				File filename = new File(projectpath+ articleChapter.getContentUrl());
				InputStreamReader reader = new InputStreamReader(new FileInputStream(filename), "utf-8");
				BufferedReader br = new BufferedReader(reader);
				String line = "";
				line = br.readLine();
				while (line != null) {
					line = br.readLine();
					chapterTxt = chapterTxt + line + "\r\n";
				}
				request.setAttribute("articleChapter", articleChapter);
				request.setAttribute("chapterTxt", chapterTxt);
				System.out.println("免费章节");
			}
		} catch (Exception e) {
			logger.error(e.toString(), e);
		}
		return "home/read/bookstore/changeColor";
	}
}
